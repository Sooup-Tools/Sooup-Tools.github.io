<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="style.css">
  <title>Bluesky Engagement Grapher</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script type="module">
    import { AtpAgent } from "https://esm.sh/@atproto/api";

    let agent;

    async function login() {
      agent = new AtpAgent({ service: "https://bsky.social" });
      try{
        await agent.login({
          identifier: document.getElementById("handle").value,
          password: document.getElementById("password").value
        });
        document.body.style.backgroundColor = "#d0ebff"; // light blue;
        document.getElementById("statusMessage").textContent = "✅ Login successful! You can now graph engagement.";
        document.getElementById("statusMessage").style.color = "green";
      } catch (error) {
        console.error("❌ Login failed:", error);
        document.getElementById("statusMessage").textContent = "❌ Login failed. Please check your credentials.";
        document.getElementById("statusMessage").style.color = "red";
      }
    }

    async function fetchAllPosts(did, includeReplies, onProgress) {
      let posts = [];
      let cursor;

      while (true) {
        const response = await agent.getAuthorFeed({
          actor: did,
          limit: 100,
          cursor
        });

        posts = posts.concat(response.data.feed);

        if (onProgress) onProgress(posts.length);

        if (!response.data.cursor) break;
        cursor = response.data.cursor;

        // Safety cutoff
        if (posts.length > 5000) break;
      }

      return posts;
    }

    async function graphEngagement() {
      const username = document.getElementById("handle").value;
      const includeReplies = document.getElementById("includeReplies").checked;

      // Show spinner
      document.getElementById("spinner").style.display = "inline-block";
      document.getElementById("progressText").textContent = "Fetching posts…";

      const profile = await agent.getProfile({ actor: username });

      const feedItems = await fetchAllPosts(profile.data.did, includeReplies, count => {
        document.getElementById("progressText").textContent = `Fetched ${count} posts so far…`;
      });

      // Hide spinner when done
      document.getElementById("spinner").style.display = "none";
      document.getElementById("progressText").textContent = `Fetched ${feedItems.length} posts total.`;

      let x = [];
      let y = [];
      let texts = [];

      feedItems.forEach(item => {
        const post = item.post;

        // Skip reposts
        if (item.reason?.$type === "app.bsky.feed.defs#reasonRepost") return;

        // Skip non-authored posts
        if (post.author?.did !== profile.data.did) return;

        // Skip replies unless chosen
        if (post.record?.reply && !includeReplies) return;

        const isQuote = !!post.embed?.record;

        const likes = post.likeCount || 0;
        const replies = post.replyCount || 0;
        const reposts = post.repostCount || 0;
        const quotes = post.quoteCount || 0;

        const engagement = likes + replies + reposts + quotes;
        const date = new Date(post.indexedAt);

        x.push(date);
        y.push(engagement);
        texts.push(
          `${isQuote ? "Quote Post" : "Post"}: ${post.record?.text || "[no text]"}<br>` +
          `Likes: ${likes}, Replies: ${replies}, Reposts: ${reposts}, Quotes: ${quotes}`
        );
      });

      Plotly.newPlot("plot", [{
        x, y, mode: "markers", type: "scatter", text: texts, marker: { size: 10 }
      }], {
        title: "Engagement Over Time",
        xaxis: { title: "Date" },
        yaxis: { title: "Engagement" }
      });
    }

    window.login = login;
    window.graphEngagement = graphEngagement;
  </script>

</head>
<body>
  <h2>Bluesky Engagement Grapher</h2>
  <p><a href="https://sooup-tools.github.io/webpage">Home</a></p>
  <div id="statusMessage" style="margin-bottom:20px; font-weight:bold;"></div>
  <label>Handle: <input type="text" id="handle"></label>
  <label>Password: <input type="password" id="password"></label>
  <button onclick="login()">Login</button>

  <hr style="margin:20px 0;">

  <button onclick="graphEngagement()">Graph Engagement!</button>
  <label>
    <input type="checkbox" id="includeReplies"> Include replies as posts
  </label>

  <div style="margin-top:10px;">
    <div id="spinner"></div>
    <div id="progressText"></div>
  </div>

  <div id="plot" style="width:100%;height:600px;"></div>
</body>
</html>